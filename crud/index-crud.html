<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

    <h2>Gestión de productos</h2>

    <form id="ProductoForm" class="mt-4" novalidate enctype="multipart/form-data">
        <input type="hidden" id="id_producto">

        <div class="mb-2">
            <label for="nombre_producto" class="form-label">Nombre del producto</label>
            <input type="text" class="form-control" id="nombre_producto">
        </div>

        <div class="mb-2">
            <label for="descripcion_producto" class="form-label">Descripción del producto</label>
            <input type="text" class="form-control" id="descripcion_producto">
        </div>

        <div class="mb-2">
            <label for="precio_producto" class="form-label">Precio del producto</label>
            <input type="number" min="0" class="form-control" id="precio_producto">     
        </div>

        <div class="mb-2">
            <label for="stock_producto" class="form-label">Stock</label>
            <input type="number" min="0" class="form-control" id="stock_producto">
        </div>

        <div class="mb-2">
            <label for="descuento_producto" class="form-label">Descuento</label>
            <input type="number" min="0" class="form-control" id="descuento_producto">
        </div>

        <div class="mb-2">
            <label for="categoria_id">Seleccionar categoría:</label>
            <select id="categoria_id" class="form-select">
                <option value="">Selecciona una opción</option>
                <option value="1">Ropa</option>
                <option value="2">Calzado</option>
                <option value="3">Accesorios</option>
            </select>
        </div>

        <div class="mb-2">
            <label for="imagen" class="form-label">Imagen *</label>
            <input type="file" id="selImg" name="imagen" class="form-control">
        </div>

        <div class="d-flex gap-2 mb-4">
            <button type="button" class="btn btn-info" onclick="cargarProductos()">Buscar producto</button>
            <button type="button" class="btn btn-primary" onclick="guardarProducto()">Guardar Producto</button>
            <button type="reset" class="btn btn-secondary" onclick="resetFormulario()">Cancelar</button>
        </div>
    </form>

    <div id="resultado"></div>

    <h4 class="mt-4">Lista de Productos</h4>
    <table class="table table-bordered" id="tablaProductos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Descuento</th>
                <th>Categoría</th>
                <th>Imagen</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", cargarProductos);

        function cargarProductos() {
            const filtros = {
                nombre_producto: document.getElementById('nombre_producto').value.trim(),
                descripcion_producto: document.getElementById('descripcion_producto').value.trim(),
                categoria_id: document.getElementById('categoria_id').value.trim(),
            };

            fetch("get.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(filtros)
            })
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("#tablaProductos tbody");
                tbody.innerHTML = "";
                data.forEach(producto => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${producto.id_producto}</td>
                            <td>${producto.nombre_producto}</td>
                            <td>${producto.descripcion_producto}</td>
                            <td>${producto.precio_producto}</td>
                            <td>${producto.stock_producto}</td>
                            <td>${producto.descuento_producto}</td>
                            <td>${producto.nombre_categoria}</td>
                            <td>
                                <img src="imgs/${producto.imagen_producto}" 
                                    onerror="this.src='imgs/noimage.png'" 
                                    width="100" height="100" style="object-fit: cover;">
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick='editarProducto(${JSON.stringify(producto)})'>Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${producto.id_producto})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        function validarFormulario() {
            const nombre = document.getElementById('nombre_producto').value.trim();
            const descripcion = document.getElementById('descripcion_producto').value.trim();
            const precio = document.getElementById('precio_producto').value.trim();
            const stock = document.getElementById('stock_producto').value.trim();
            const descuento = document.getElementById('descuento_producto').value.trim();
            const categoria = document.getElementById('categoria_id').value.trim();
            const imagen = document.getElementById('selImg');

            const errores = [];

            if (nombre === '') errores.push("Nombre es obligatorio.");
            if (descripcion === '') errores.push("Descripción es obligatoria.");
            if (precio === '') errores.push("Precio es obligatorio.");
            if (stock === '') errores.push("Stock es obligatorio.");
            if (descuento === '') errores.push("Descuento es obligatorio.");
            if (categoria === '') errores.push("Categoría es obligatoria.");

            const id = document.getElementById('id_producto').value;
            if (id === "" && imagen.files.length === 0) {
                errores.push("Selecciona una imagen para el producto.");
            }

            if (errores.length > 0) {
                document.getElementById('resultado').innerHTML = `
                    <div class="alert alert-danger">
                        <ul>${errores.map(e => `<li>${e}</li>`).join('')}</ul>
                    </div>`;
                return false;
            }
            return true;
        }

        function guardarProducto() {
            if (!validarFormulario()) return;

            const formData = new FormData();
            formData.append("id_producto", document.getElementById('id_producto').value.trim());
            formData.append("nombre_producto", document.getElementById('nombre_producto').value.trim());
            formData.append("descripcion_producto", document.getElementById('descripcion_producto').value.trim());
            formData.append("precio_producto", document.getElementById('precio_producto').value.trim());
            formData.append("stock_producto", document.getElementById('stock_producto').value.trim());
            formData.append("descuento_producto", document.getElementById('descuento_producto').value.trim());
            formData.append("categoria_id", document.getElementById('categoria_id').value.trim());

            const archivo = document.getElementById('selImg');
            if (archivo.files.length > 0) {
                formData.append("imagen", archivo.files[0]);
            }

            const url = formData.get("id_producto") === "" ? "post.php" : "put.php";

            fetch(url, {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.message || data.mensaje) {
                    document.getElementById('resultado').innerHTML = `<div class="alert alert-success">${data.message || data.mensaje}</div>`;
                    resetFormulario();
                    cargarProductos();
                } else if (data.errores) {
                    document.getElementById('resultado').innerHTML = `<div class="alert alert-danger"><ul>${data.errores.map(e => `<li>${e}</li>`).join('')}</ul></div>`;
                }
            });
        }

        function resetFormulario() {
            document.getElementById("ProductoForm").reset();
            document.getElementById("id_producto").value = "";
        }

        function eliminarProducto(id) {
            if (!confirm("¿Estás seguro de eliminar este producto?")) return;

            fetch("delete.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: id })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('resultado').innerHTML = `<div class="alert alert-success">${data.mensaje}</div>`;
                cargarProductos();
            });
        }

        function editarProducto(producto) {
            document.getElementById('id_producto').value = producto.id_producto;
            document.getElementById('nombre_producto').value = producto.nombre_producto;
            document.getElementById('descripcion_producto').value = producto.descripcion_producto;
            document.getElementById('precio_producto').value = producto.precio_producto;
            document.getElementById('stock_producto').value = producto.stock_producto;
            document.getElementById('descuento_producto').value = producto.descuento_producto;
            document.getElementById('categoria_id').value = producto.categoria_id;
            // No se muestra imagen al editar por ahora
        }
    </script>
</body>
</html>
